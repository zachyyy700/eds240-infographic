---
title: "EDS 240: Final Project - Exploratory Analysis"
author: "Zach Loo"
---

[Data Source](https://www.kaggle.com/datasets/takamotoki/jra-horse-racing-dataset/data)

# Begin EDA 

```{r}
# Load packages
library(tidyverse)
library(jtools)
library(gghighlight)
```

```{r}
# Load data, parsing certain columns as character
jra_results <- read_csv(here::here('data', '19860105-20210731_race_result.csv'),
col_types = cols(レース馬番ID = 'c', レースID = 'c', タイム = 'c')) |> 
    # Omit レース記号 columns
    select(-starts_with("レース記号"))
```

## Initial Wrangling

A language barrier was anticipated with this dataset. For ease of use, the dataset's columns can be translated.

```{r}
# Create dataset copy
jra_results_eng <- jra_results

# Translate df columns
colnames(jra_results_eng) <- c("race_pp_id", "race_id", "race_date", "race_meeting_number", "racecourse_code", "racecourse_name", "nth_raceday", "race_prereq", "race_number", "graded_race_nth_time", "race_name", "listed_graded_race", "steeplechase", "turf_dirt", "turf_dirt2_steeplechase", "left_right_straight", "inside_outside", "distance_m", "weather", "track_condition1", "track_condition2_steeplechase", "post_time", "final_position", "final_position_notes", "bracket_number", "horse_number", "horse_name", "horse_sex", "horse_age", "weight", "jockey_name", "finish_time", "margin", "corner1_position", "corner2_position", "corner3_position", "corner4_position", "final_600m_time", "win_odds_100Y", "popular_rank", "horse_weight", "horse_weight_diff", "east_west_foreign", "horse_trainer", "horse_owner", "prize_money_10kY")

#jra_odds <- read_csv(here::here("data", "19860105-20210731_odds.csv"))
```

```{r}
# Add year and month columns
jra_results_eng  <- jra_results_eng |> 
    mutate(year = year(race_date), month = month(race_date))

# Convert character to duration
jra_results_eng$finish_time <- ms(jra_results_eng$finish_time)
jra_results_eng$finish_time <- as.duration(jra_results_eng$finish_time)

```

## Overall Summary Plots

### Weather Summary

```{r}
# Weather bar plot
jra_results_eng |> 
    group_by(weather) |> 
    summarise(count = n()) |> 
    ggplot(aes(x = count, y = fct_reorder(weather, count))) +
    labs(x = "Amount of Days", y = "Weather") +
    geom_bar(stat = "identity")
```

Most of race days are sunny, followed by cloudy, then rainy/light rain.

```{r}
# Spread of G1 races throughout the year
```

### Age Summary

```{r}
# Horse age histogram
# jra_results_eng |> 
#     ggplot(aes(x = horse_age, y = after_stat(density))) +
#     geom_histogram(binwidth = 1) +
#     scale_x_continuous(breaks = seq(0, 16, by = 1))
```

Since horse age is discrete, numerical variable, it may make more sense to plot this as a lollipop chart. Also, there are a lot of observations in this dataset so having percentage instead of count on the y-axis will be easier on the eyes.

```{r}
# Horse age lollipop
jra_results_eng |> 
    group_by(horse_age) |> 
    summarise(age_count = n()) |> 

    ggplot() +
    geom_point(aes(x = horse_age, y = age_count / sum(age_count) * 100)) +
    geom_linerange(aes(x = horse_age, ymin = 0, ymax = age_count / sum(age_count) * 100)) +

    labs(x = "Horse Age", y = "Percentage (%)") +

    scale_x_continuous(breaks = seq(0, 16, by = 1)) +
    scale_y_continuous(breaks = seq(0, 30, by = 5), labels = scales::label_percent(scale = 1)) +
    theme_minimal()
```

### Turf vs Dirt

```{r}
jra_results_eng |> 
    group_by(turf_dirt) |> 
    summarise(n = n())
```

## Specific Descriptive Plots

### Successful Horses by Prize Money

```{r}
# Total horse winnings
winnings_df <- jra_results_eng |> 
    group_by(horse_name) |> 
    summarise(avg_winnings_per_race = mean(prize_money_10kY, na.rm = TRUE),
    n_races = n()) |> 
    arrange(desc(avg_winnings_per_race))

```

### Horse Weight vs Performace

```{r}
# Weight effects on performace (top3 placement)
jra_results_eng |> 
    mutate(placed_top3 = ifelse(final_position %in% c(1, 2, 3), 1, 0)) |> 
    group_by(horse_weight) |> 
    summarise(perc_top3 = sum(placed_top3) / n()) |> 
    ggplot(aes(horse_weight, perc_top3)) +
    geom_point()

```

In this horse weight vs top 3 percentage plot, 'outlier' horses seem to have "skewed" win percentages due to a small7 sample size perhaps? 

### Horse Age vs Performance

```{r}
# Age effects on performance (top3 placement)
jra_results_eng |> 
    mutate(placed_top3 = ifelse(final_position %in% c(1, 2, 3), 1, 0)) |> 
    group_by(horse_age) |> 
    summarise(perc_top3 = sum(placed_top3) / n()) |> 
    ggplot(aes(horse_age, perc_top3)) +
    geom_point()
```

In this horse age vs top 3 percentage, it could be suffering from the same bias as the above. 

### Race Distance Explorations

```{r}
# See distance distribution
ggplot(jra_results_eng, aes(x = distance_m)) +
    geom_histogram(binwidth = 100) +
    scale_x_continuous(breaks = seq(min(jra_results_eng$distance_m), max(jra_results_eng$distance_m), by = 200)) +
    theme_minimal()

# Add distance category
jra_results_eng  <- jra_results_eng |> 
    mutate(distance_category = case_when(
        distance_m <= 1400 ~ "sprint",
        distance_m > 1400 & distance_m <= 1800 ~ "mile",
        distance_m > 1800 & distance_m <= 2200 ~ "medium",
        distance_m > 2200 ~ "long"
    ))
```

```{r}
# Different distances, average first place finish time over time
times_2000 <- jra_results_eng |> 
    filter(distance_m == 2000, final_position == 1) |> 
    group_by(year) |> 
    summarise(mean_2000m_win_time_sec = mean(finish_time, na.rm = TRUE))
```

```{r}
ggplot(times_2000, aes(x = year, y = mean_2000m_win_time_sec)) +
    geom_point()
```

```{r}
# Build map function for different race distances
distances_win_times <- map_dfr(set_names(c(1200, 1600, 2000)), ~{
    jra_results_eng |> 
        filter(distance_m == .x, final_position == 1) |> 
        group_by(year) |> 
        summarise(mean_win_time_sec = mean(finish_time, na.rm = TRUE))
}, .id = "distance_m")

ggplot(distances_win_times, aes(year, mean_win_time_sec)) +
    geom_point() +
    facet_wrap(~distance_m, scales = "free_y")
```

For the above plot, must consider dirt vs turf times?

```{r}
# Pivot to long for this step
jra_results_long <- jra_results_eng |> 
    pivot_longer(cols = c(corner1_position:corner4_position, final_position),
    names_to = "corner_number", names_pattern = "(.*)_position",
    values_to = "position")

#......................Plots for runner type.....................
# Front: 2017 Arima Kinen, キタさんブラック
jra_results_long |> 
    filter(race_name == "有馬記念" & year == 2017) |> 
    ggplot(aes(x = corner_number, y = factor(position), group = horse_name, color = horse_name)) +
    geom_line(linewidth = 1.5) +

    # Reverse y-axis for more intuitive plot
    scale_y_discrete(limits = rev) +
    # Finish line & label
    geom_vline(aes(xintercept = "final"), color = "black", linewidth = 1.2, linetype = "dashed") +

    #geom_label(aes(x = "final", y = 2), label = "Finish") +
    theme_minimal() +

    # Highlight winner
    gghighlight(horse_name == "キタサンブラック", 
    label_params = list(
        nudge_x = -1.5, nudge_y = 1
    ), 
    use_group_by = FALSE) +
    
    theme(axis.title.x = element_blank())


# Pace
jra_results_long |> 
    filter(race_name == "有馬記念" & year == 1993) |> 
    ggplot(aes(x = corner_number, y = factor(position), group = horse_name, color = horse_name)) +
    geom_line(linewidth = 1.5) +

    # Reverse y-axis for more intuitive plot
    scale_y_discrete(limits = rev) +

    # Highlight winner
    gghighlight(horse_name == "トウカイテイオー", 
    label_params = list(
        nudge_x = -1.5, nudge_y = 1
    ), 
    use_group_by = FALSE) +
    
    theme(axis.title.x = element_blank())

# Late

# End
```

```{r}
# 1993 Arima Kinen
arima_kinen_93 <- jra_results_eng |> 
    filter(race_name == "有馬記念" & year == 1993)

ak_93_long <- arima_kinen_93 |> 
    pivot_longer(cols = c(corner1_position:corner4_position, final_position), names_to = "corner_number", names_pattern = "(.*)_position",
    values_to = "position")

ggplot(ak_93_long, aes(corner_number, factor(position), group = horse_name, color = horse_name)) +
    geom_line() +
    scale_y_discrete(limits = rev) +
    gghighlight::gghighlight(horse_name == "トウカイテイオー") +
    theme_minimal()
```

```{r}
# All Arima Kinen, favorite to win & actual win
all_arima_kinen <- jra_results_eng |> 
    filter(race_name == "有馬記念") |> 
    mutate(favorite_won = case_when(
        popular_rank == 1 & final_position == 1 ~ 1,
        TRUE ~ 0
    )) |> 

    mutate(secondfavorite_won = case_when(
        popular_rank == 2 & final_position == 1 ~ 1,
        TRUE ~ 0
    )) |> 
    
    mutate(thirdfavorite_won = case_when(
        popular_rank == 3 & final_position == 1 ~ 1,
        TRUE ~ 0
    )) |> 
    
    mutate(favorite_won_or_placed = case_when(
        popular_rank == 1 & final_position %in% c(1,2) ~ 1,
        TRUE ~ 0
    ))
```

```{r}
# All AK winrate
all_arima_kinen |> 
    filter(popular_rank == 1) |> 
    summarise(win_rate = mean(final_position == 1, na.rm = TRUE))
```

According to the above calculation, at the annual Arima Kinen, the number one favorite has won 41.2% of the time.

```{r}
# All AK, favorite rank vs final position
ggplot(all_arima_kinen, aes(popular_rank, final_position)) +
    geom_point()
```

```{r}
# Gender compostion
jra_results_eng |> 
    group_by(horse_sex) |> 
    summarise(sexcount = n()) |> 
    ggplot(aes(horse_sex, sexcount)) +
    geom_bar(stat = 'identity')
```

# EDA Questions

1. What have you learned about your data? Have any potentially interesting patterns emerged? Point to specific visualizations that you created as you describe your findings.

2. In FPM #1, you outlined some questions that you wanted to answer using these data. Have you made any strides towards answering those questions? If yes, how so? If no, what next steps do you need to take (e.g. I need to create X plot type, I still need to track down Y data, I need to restructure existing data so that you can visualize it in Z ways, etc.)? Have any new questions emerged?

3. What challenges do you foresee encountering with your data? These can be data wrangling and / or visualization challenges.